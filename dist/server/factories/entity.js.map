{"version":3,"sources":["../../../src/server/factories/entity.js"],"names":[],"mappings":"8EA8FgB;;;;;GAtEhB,SAAS,YAAT,CAAsB,OAAtB,CAA+B,KAA/B,CAAsC,CACpC,IAAM,OAAS,qBAAW,KAAX,CAAT,CAD8B,IAG9B,wBAA0B,SAA1B,uBAA0B,CAAS,KAAT,CAAgB,QAAhB,CAA0B,CACxD,GAAI,CAAC,MAAM,MAAN,EAAgB,MAAM,aAAN,EAAuB,CAAvB,CAA0B,aAC7C,SAAS,wBAAW,MAAM,EAAN,CAAU,MAAM,cAAN,CAA9B,EAEA,IAAM,KAAO,QAAQ,SAAR,CAAkB,MAAM,IAAN,CAAzB,2BACW,qCAA2B,KAAK,KAAL,CAAY,KAAvC,MAAT,8BAAG;AAGX,WAAW,UAAM,CACf,SAAS,yBAAY,MAAM,EAAN,CAAU,CAAtB,CAAyB,CAAzB,CAAT,EADe,UAGf,CAAW,UAAM,CACf,SAAS,uBAAU,MAAM,EAAN,CAAnB,EADe,CAEd,GAFH,EAHe,CAMd,MAAM,cAAN,CANH,KAP6C,CADjB,CAHI,MAqBpC,CAAO,YAAP,CAAoB,qBAAoB,uBAApB,CAApB,EArBoC,OAuB7B,MAAP,CAvBoC;;;;;wDAgCtC,SAAS,UAAT,CAAoB,OAApB,CAA6B,KAA7B,CAAoC,CAClC,IAAM,OAAS,qBAAW,KAAX,CAAT,CAD4B,OAG3B,MAAP,CAHkC;;;;;GAYpC,SAAS,UAAT,CAAoB,OAApB,CAA6B,KAA7B,CAAoC,CAClC,IAAM,OAAS,qBAAW,KAAX,CAAT,CAD4B,IAG5B,wBAA0B,SAA1B,uBAA0B,CAAS,WAAT,CAAsB,QAAtB,CAAgC,gBAC9D,GAAI,YAAY,OAAZ,EAAuB,YAAY,QAAZ,EAAwB,KAAK,gBAAL,EAA/C,CAAwE,aAC1E,IAAM,OAAS,YAAY,QAAZ,2BAAT,CAEN,oBAAQ,YAAY,OAAZ,CAAqB,kBAAY,CACvC,SAAS,wBAAW,QAAX,CAAqB,MAArB,CAAT,EADuC,CAAzC,CAIA,MAAK,WAAL,OAP0E,CAD9C,CAHE,MAelC,CAAO,YAAP,CAAoB,qBAAoB,uBAApB,CAApB,EAfkC,OAiB3B,MAAP,CAjBkC;;;;;GA0B7B,SAAS,YAAT,CAAsB,OAAtB,CAA+B,KAA/B,CAAsC,CAC3C,OAAQ,MAAM,IAAN,EACN,KAAK,wBAAY,MAAZ,CACH,OAAO,aAAa,OAAb,CAAsB,KAAtB,CAAP,CADF,KAGK,wBAAY,IAAZ,CACH,OAAO,WAAW,OAAX,CAAoB,KAApB,CAAP,CADF,KAGK,wBAAY,IAAZ,CACH,OAAO,WAAW,OAAX,CAAoB,KAApB,CAAP,CADF,QAIE,eAAO,IAAP,4CAAuD,MAAM,IAAN,IAAvD,EADF,OAES,IAAP,CAFF,CAXyC,CAAtC","file":"entity.js","sourcesContent":["/*eslint no-shadow: 0*/\n/*eslint no-unused-vars: 0*/\n\nimport { forEach } from 'lodash';\nimport { logger } from '../helpers/vendor';\nimport Entity from 'shared/game/entity';\nimport HealthComponent from '../game/components/health';\nimport PointsComponent from '../game/components/points';\nimport { POINTS_PER_FLAG } from '../constants';\nimport {\n  killEntity,\n  beginRevive,\n  endRevive,\n  givePoints\n} from '../actions/entity';\nimport { calculateTeamSpawnPosition } from '../helpers/game';\nimport { EntityTypes } from 'shared/constants';\n\n/**\n *\n * @param {Session} session\n * @param {Object} props\n * @returns {Entity}\n */\nfunction createPlayer(session, props) {\n  const entity = new Entity(props);\n\n  const onHealthComponentUpdate = function(props, dispatch) {\n    if (!props.isDead && props.currentHealth <= 0) {\n      dispatch(killEntity(props.id, props.lastAttackerId));\n\n      const team = session.getEntity(props.team);\n      const { x, y } = calculateTeamSpawnPosition(team.props, props);\n      \n      // Automatically revive the entity in a while\n      setTimeout(() => {\n        dispatch(beginRevive(props.id, x, y));\n\n        setTimeout(() => {\n          dispatch(endRevive(props.id));\n        }, 500);\n      }, props.reviveDuration);\n    }\n  };\n\n  entity.addComponent(new HealthComponent(onHealthComponentUpdate));\n\n  return entity;\n}\n\n/**\n *\n * @param {Session} session\n * @param {Object} props\n * @returns {Entity}\n */\nfunction createFlag(session, props) {\n  const entity = new Entity(props);\n\n  return entity;\n}\n\n/**\n *\n * @param {Session} session\n * @param {Object} props\n * @returns {Entity}\n */\nfunction createTeam(session, props) {\n  const entity = new Entity(props);\n\n  const onPointsComponentUpdate = function(updateProps, dispatch) {\n    if (updateProps.players && updateProps.numFlags && this.shouldGivePoints()) {\n      const points = updateProps.numFlags * POINTS_PER_FLAG;\n\n      forEach(updateProps.players, playerId => {\n        dispatch(givePoints(playerId, points));\n      });\n      \n      this.pointsGiven();\n    }\n  };\n\n  entity.addComponent(new PointsComponent(onPointsComponentUpdate));\n\n  return entity;\n}\n\n/**\n *\n * @param {Session} session\n * @param {Object} props\n * @returns {Entity}\n */\nexport function createEntity(session, props) {\n  switch (props.type) {\n    case EntityTypes.PLAYER:\n      return createPlayer(session, props);\n\n    case EntityTypes.FLAG:\n      return createFlag(session, props);\n\n    case EntityTypes.TEAM:\n      return createTeam(session, props);\n\n    default:\n      logger.warn(`trying to create entity of unknown type ${props.type}.`);\n      return null;\n  }\n}\n"]}